@model IEnumerable<License_Tracking.Models.Deal>

@{
    ViewData["Title"] = "License Management - Phase 3 (License Delivery)";
}

<div class="container-fluid">
    <!-- CBMS B2B2B Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1"><i class="fas fa-certificate text-success"></i> License Management</h2>
                    <p class="text-muted mb-0">Phase 3: License Delivery & Customer License Management</p>
                </div>
                <div class="d-flex gap-2">
                    @if (User.IsInRole("Admin") || User.IsInRole("Sales"))
                    {
                        <a class="btn btn-success" asp-controller="Deals" asp-action="Create">
                            <i class="fas fa-plus"></i> New Deal
                        </a>
                        <a class="btn btn-outline-primary" asp-controller="Deals" asp-action="Index">
                            <i class="fas fa-handshake"></i> All Deals
                        </a>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- 4-Phase Workflow Navigation -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-light border-0">
                <div class="card-body py-3">
                    <div class="row text-center">
                        <div class="col-3">
                            <a asp-controller="Deals" asp-action="Index" asp-route-phase="1"
                                class="text-decoration-none">
                                <div class="p-2 border-end">
                                    <i class="fas fa-user-check fa-lg text-primary"></i>
                                    <p class="mb-0 mt-1 fw-bold text-primary">Phase 1</p>
                                    <small class="text-muted">Customer PO</small>
                                </div>
                            </a>
                        </div>
                        <div class="col-3">
                            <a asp-controller="Deals" asp-action="Index" asp-route-phase="2"
                                class="text-decoration-none">
                                <div class="p-2 border-end">
                                    <i class="fas fa-shopping-cart fa-lg text-info"></i>
                                    <p class="mb-0 mt-1 fw-bold text-info">Phase 2</p>
                                    <small class="text-muted">OEM Procurement</small>
                                </div>
                            </a>
                        </div>
                        <div class="col-3">
                            <div class="p-2 border-end bg-success text-white rounded">
                                <i class="fas fa-certificate fa-lg"></i>
                                <p class="mb-0 mt-1 fw-bold">Phase 3</p>
                                <small>License Delivery</small>
                            </div>
                        </div>
                        <div class="col-3">
                            <a asp-controller="Deals" asp-action="Index" asp-route-phase="4"
                                class="text-decoration-none">
                                <div class="p-2">
                                    <i class="fas fa-money-check-alt fa-lg text-warning"></i>
                                    <p class="mb-0 mt-1 fw-bold text-warning">Phase 4</p>
                                    <small class="text-muted">OEM Settlement</small>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- License Status Overview Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <h3 class="mb-1">@Model.Count(d => d.LicenseDeliveryStatus == "Pending")</h3>
                    <p class="mb-0">Pending Delivery</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h3 class="mb-1">@Model.Count(d => d.LicenseDeliveryStatus == "Delivered")</h3>
                    <p class="mb-0">Recently Delivered</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h3 class="mb-1">@Model.Count(d => d.LicenseDeliveryStatus == "Active")</h3>
                    <p class="mb-0">Active Licenses</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body text-center">
                    <h3 class="mb-1">@Model.Count(d => d.LicenseEndDate.HasValue && d.LicenseEndDate.Value <=
                                                DateTime.Now.AddDays(30))</h3>
                    <p class="mb-0">Expiring Soon</p>
                </div>
            </div>
        </div>
    </div>

    <!-- License Management Table -->
    <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-certificate"></i> Phase 3: License Delivery Management</h5>
        </div>
        <div class="card-body">
            <!-- Search and Filter Options -->
            <div class="row mb-3">
                <div class="col-md-4">
                    <input type="text" class="form-control" placeholder="Search by Deal Name, Customer, or Product..."
                        id="searchInput">
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="statusFilter">
                        <option value="">All License Status</option>
                        <option value="Pending">Pending Delivery</option>
                        <option value="Delivered">Delivered</option>
                        <option value="Active">Active</option>
                        <option value="Expired">Expired</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="expiryFilter">
                        <option value="">All Expiry Status</option>
                        <option value="expiring">Expiring in 30 Days</option>
                        <option value="expired">Already Expired</option>
                        <option value="active">Active (Future Expiry)</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-striped table-hover" id="licenseTable">
                    <thead class="table-success">
                        <tr>
                            <th><i class="fas fa-handshake"></i> Deal Name</th>
                            <th><i class="fas fa-building"></i> Customer</th>
                            <th><i class="fas fa-store"></i> OEM</th>
                            <th><i class="fas fa-box"></i> Product</th>
                            <th><i class="fas fa-calendar-alt"></i> License Period</th>
                            <th><i class="fas fa-certificate"></i> Delivery Status</th>
                            <th><i class="fas fa-stopwatch"></i> Days to Expiry</th>
                            <th><i class="fas fa-cogs"></i> Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null && Model.Any())
                        {
                            @foreach (var deal in Model.Where(d => !string.IsNullOrEmpty(d.DealName)))
                            {
                                var daysToExpiry = deal.LicenseEndDate.HasValue ? (deal.LicenseEndDate.Value -
                                DateTime.Now).Days : 0;
                                var expiryClass = daysToExpiry <= 0 ? "text-danger" : daysToExpiry <= 30 ? "text-warning" :
                                "text-success";
                                var statusBadge = deal.LicenseDeliveryStatus switch
                                {
                                    "Pending" => "badge bg-warning",
                                    "Delivered" => "badge bg-info",
                                    "Active" => "badge bg-success",
                                    _ => "badge bg-secondary"
                                };

                                <tr>
                                    <td>
                                        <strong>@deal.DealName</strong>
                                        <br><small class="text-muted">@deal.DealType</small>
                                    </td>
                                    <td>
                                        @(deal.Company?.CompanyName ?? "N/A")
                                        <br><small class="text-muted">@(deal.Company?.Industry ?? "")</small>
                                    </td>
                                    <td>
                                        @(deal.Oem?.OemName ?? "N/A")
                                        <br><small class="text-muted">Service: @(deal.Oem?.ServiceLevel ?? "N/A")</small>
                                    </td>
                                    <td>
                                        @(deal.Product?.ProductName ?? "N/A")
                                        <br><small class="text-muted">Qty: @deal.Quantity</small>
                                    </td>
                                    <td>
                                        @if (deal.LicenseStartDate.HasValue && deal.LicenseEndDate.HasValue)
                                        {
                                            <strong>@deal.LicenseStartDate.Value.ToString("MM/dd/yyyy")</strong>
                                            <br>

                                            <span class="text-muted">to</span>
                                            <br>

                                            <strong>@deal.LicenseEndDate.Value.ToString("MM/dd/yyyy")</strong>
                                        }
                                        else
                                        {
                                            <span class="text-muted">Not Set</span>
                                        }
                                    </td>
                                    <td>
                                        <span class="@statusBadge">@(deal.LicenseDeliveryStatus ?? "Unknown")</span>
                                    </td>
                                    <td class="@expiryClass">
                                        @if (deal.LicenseEndDate.HasValue)
                                        {
                                            if (daysToExpiry <= 0)
                                            {
                                                <strong>EXPIRED</strong>
                                                <br>

                                                <small>@Math.Abs(daysToExpiry) days ago</small>
                                            }
                                            else if (daysToExpiry <= 30)
                                            {
                                                <strong>@daysToExpiry days</strong>
                                                <br>

                                                <small class="text-warning">Expiring Soon!</small>
                                            }
                                            else
                                            {
                                                <strong>@daysToExpiry days</strong>
                                            }
                                        }
                                        else
                                        {
                                            <span class="text-muted">N/A</span>
                                        }
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a asp-controller="Deals" asp-action="Details" asp-route-id="@deal.DealId"
                                                class="btn btn-outline-info" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            @if (User.IsInRole("Admin") || User.IsInRole("Sales"))
                                            {
                                                <a asp-controller="Deals" asp-action="Edit" asp-route-id="@deal.DealId"
                                                    class="btn btn-outline-primary" title="Edit License">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                            }
                                            @if (deal.LicenseEndDate.HasValue && deal.LicenseEndDate.Value <=
                                                                                DateTime.Now.AddDays(60))
                                            {
                                                <a asp-controller="Renewal" asp-action="Create" asp-route-dealId="@deal.DealId"
                                                    class="btn btn-outline-success" title="Renew License">
                                                    <i class="fas fa-sync-alt"></i>
                                                </a>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="8" class="text-center py-4">
                                    <div class="text-muted">
                                        <i class="fas fa-certificate fa-3x mb-3"></i>
                                        <h5>No Licenses Found</h5>
                                        <p>No deals with license information are available.</p>
                                        <a asp-controller="Deals" asp-action="Create" class="btn btn-success">
                                            <i class="fas fa-plus"></i> Create New Deal
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Quick Actions Panel -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card bg-light">
                <div class="card-body">
                    <h6 class="card-title"><i class="fas fa-rocket"></i> Quick Actions</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <a asp-controller="Deals" asp-action="Index" asp-route-phase="3" asp-route-status="Pending"
                                class="btn btn-outline-warning w-100 mb-2">
                                <i class="fas fa-clock"></i> Pending Deliveries
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a asp-controller="Report" asp-action="ExpiringLicenses"
                                class="btn btn-outline-danger w-100 mb-2">
                                <i class="fas fa-exclamation-triangle"></i> Expiring Licenses
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a asp-controller="Renewal" asp-action="Index" class="btn btn-outline-success w-100 mb-2">
                                <i class="fas fa-sync-alt"></i> Renewal Management
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a asp-controller="Report" asp-action="LicenseReport"
                                class="btn btn-outline-primary w-100 mb-2">
                                <i class="fas fa-chart-bar"></i> License Reports
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Search and Filter Functionality
        document.getElementById('searchInput').addEventListener('keyup', function () {
            filterTable();
        });

        document.getElementById('statusFilter').addEventListener('change', function () {
            filterTable();
        });

        document.getElementById('expiryFilter').addEventListener('change', function () {
            filterTable();
        });

        function filterTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const expiryFilter = document.getElementById('expiryFilter').value;
            const table = document.getElementById('licenseTable');
            const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const cells = row.getElementsByTagName('td');

                if (cells.length === 1) continue; // Skip empty message row

                let showRow = true;

                // Search filter
                if (searchTerm) {
                    const dealName = cells[0].textContent.toLowerCase();
                    const customer = cells[1].textContent.toLowerCase();
                    const product = cells[3].textContent.toLowerCase();

                    if (!dealName.includes(searchTerm) && !customer.includes(searchTerm) && !product.includes(searchTerm)) {
                        showRow = false;
                    }
                }

                // Status filter
                if (statusFilter && showRow) {
                    const status = cells[5].textContent.trim();
                    if (!status.includes(statusFilter)) {
                        showRow = false;
                    }
                }

                // Expiry filter
                if (expiryFilter && showRow) {
                    const expiryCell = cells[6];
                    const expiryText = expiryCell.textContent.toLowerCase();

                    if (expiryFilter === 'expiring' && !expiryText.includes('expiring soon')) {
                        showRow = false;
                    } else if (expiryFilter === 'expired' && !expiryText.includes('expired')) {
                        showRow = false;
                    } else if (expiryFilter === 'active' && (expiryText.includes('expired') || expiryText.includes('expiring soon'))) {
                        showRow = false;
                    }
                }

                row.style.display = showRow ? '' : 'none';
            }
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('expiryFilter').value = '';
            filterTable();
        }

        // Initialize tooltips
        document.addEventListener('DOMContentLoaded', function () {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });
    </script>
}
