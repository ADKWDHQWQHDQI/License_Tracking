@model License_Tracking.ViewModels.LicenseMarginUpdateViewModel

@{
    ViewData["Title"] = "Update Margin";
    Layout = "_Layout";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">ðŸ’° Update Margin</h2>
                <div>
                    <a asp-action="Details" asp-route-id="@Model.LicenseId" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to License
                    </a>
                </div>
            </div>

            @if (ViewBag.ErrorMessage != null)
            {
                <div class="alert alert-danger" role="alert">
                    <i class="fas fa-exclamation-triangle"></i>
                    @ViewBag.ErrorMessage
                </div>
            }

            <div class="row">
                <!-- License Information Card -->
                <div class="col-md-4">
                    <div class="card border-info mb-4">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="fas fa-info-circle"></i> License Information</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm table-borderless">
                                <tr>
                                    <td><strong>Product:</strong></td>
                                    <td>@Model.ProductName</td>
                                </tr>
                                <tr>
                                    <td><strong>Client:</strong></td>
                                    <td>@Model.ClientName</td>
                                </tr>
                                <tr>
                                    <td><strong>OEM:</strong></td>
                                    <td>@Model.OemName</td>
                                </tr>
                                <tr>
                                    <td><strong>Customer PO:</strong></td>
                                    <td>@Model.CustomerPoAmount.ToString("C")</td>
                                </tr>
                                <tr>
                                    <td><strong>OEM PO:</strong></td>
                                    <td>@Model.OemPoAmount.ToString("C")</td>
                                </tr>
                                <tr class="table-success">
                                    <td><strong>Auto Margin:</strong></td>
                                    <td>@Model.AutoCalculatedMargin.ToString("C")</td>
                                </tr>
                                <tr class="table-success">
                                    <td><strong>Auto %:</strong></td>
                                    <td>@Model.AutoCalculatedMarginPercentage.ToString("F2")%</td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <!-- Current Margin Status -->
                    <div class="card border-@(Model.HasManualOverride ? "warning" : "success") mb-4">
                        <div class="card-header bg-@(Model.HasManualOverride ? "warning" : "success") text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-@(Model.HasManualOverride ? "edit" : "calculator")"></i>Current

                                Current Status: @Model.MarginStatus
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="text-center">
                                <h4 class="text-@(Model.HasManualOverride ? "warning" : "success")">
                                    @Model.CurrentMargin.ToString("C")
                                </h4>
                                <p class="text-muted">@Model.MarginPercentage.ToString("F2")% margin</p>
                                @if (Model.MarginLastUpdated.HasValue)
                                {
                                    <small class="text-muted">by

                                        Last updated: @Model.MarginLastUpdated.Value.ToString("MM/dd/yyyy")
                                        by @Model.MarginInputBy
                                    </small>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Margin Update Form -->
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-edit"></i> Update Margin</h5>
                        </div>
                        <div class="card-body">
                            <form asp-action="UpdateMargin" method="post">
                                <input type="hidden" asp-for="LicenseId" />
                                <input type="hidden" asp-for="ProductName" />
                                <input type="hidden" asp-for="ClientName" />
                                <input type="hidden" asp-for="OemName" />
                                <input type="hidden" asp-for="CustomerPoAmount" />
                                <input type="hidden" asp-for="OemPoAmount" />
                                <input type="hidden" asp-for="AutoCalculatedMargin" />

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label asp-for="ManualMarginInput" class="form-label">
                                                Manual Margin Override
                                            </label>
                                            <div class="input-group">
                               
                                                 <span class="input-group-text">$</span>
                                                      <input asp-for="ManualMarginInput" class="form-control"
                                                    placeholder="Leave blank for auto-calculation" step="0.01" />
                                            </div>
                                            <span asp-validation-for="ManualMarginInput" class="text-danger"></span>
                                            <div class="form-text">
                                                Auto-calculated: @Model.AutoCalculatedMargin.ToString("C")
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label class="form-label">Margin Percentage Preview</label>
                                            <div id="marginPreview" class="form-control-plaintext">
                                                <span class="badge bg-secondary">Will update on input</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group mb-3">
                                    <label asp-for="MarginNotes" class="form-label">
                                        Margin Notes <small class="text-muted">(Required for manual overrides)</small>
                                    </label>
                                        <textarea asp-for="MarginNotes" class="form-control" rows="3"
                                        placeholder="Explain why this margin was set manually...">
                                    </textarea>
                                    <span asp-validation-for="MarginNotes" class="text-danger"></span>
                                </div>

                                <div class="d-flex justify-content-between">
                                    <div>
                                        <button type="button" class="btn btn-info" id="getMarginSuggestions">
                                            <i class="fas fa-lightbulb"></i> Get Margin Suggestions
                                        </button>
                                    </div>
                                    <div>
                                        <button type="button" class="btn btn-secondary" onclick="clearManualInput()">
                                            <i class="fas fa-calculator"></i> Use Auto-Calculation
                                        </button>
                                        <button type="submit" class="btn btn-success">
                                            <i class="fas fa-save"></i> Update Margin
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Margin Suggestions Panel (Initially Hidden) -->
                    <div id="marginSuggestions" class="card mt-4" style="display: none;">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-chart-line"></i> Market-Based Margin Suggestions</h6>
                        </div>
                        <div class="card-body">
                            <div id="suggestionsContent">
                                <!-- Suggestions will be loaded here via AJAX -->
                            </div>
                        </div>
                    </div>

                    <!-- Margin History -->
                    @if (ViewBag.MarginHistory != null && ((List<object>)ViewBag.MarginHistory).Any())
                    {
                        <div class="card mt-4">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-history"></i> Margin History</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Old Margin</th>
                                                <th>New Margin</th>
                                                <th>Change</th>
                                                <th>Updated By</th>
                                                <th>Notes</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Margin history rows would go here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Real-time margin percentage calculation
            $('#ManualMarginInput').on('input', function () {
                const manualMargin = parseFloat($(this).val()) || 0;
                const customerAmount = @Model.CustomerPoAmount;
                const percentage = customerAmount > 0 ? (manualMargin / customerAmount) * 100 : 0;

                                if ($(this).val()) {
                    $('#marginPreview').html(`<span class="badge bg-primary">${percentage.toFixed(2)}%</span>`);
                } else {
                    $('#marginPreview').html(`<span class="badge bg-success">Auto: @Model.AutoCalculatedMarginPercentage.ToString("F2")%</span>`);
                }
            });

            // Get margin suggestions
            $('#getMarginSuggestions').click(function () {
                const button = $(this);
                button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Loading...');

                                $.get('@Url.Action("GetMarginSuggestions", "License")', { licenseId: @Model.LicenseId })
                    .done(function (response) {
                        if (response.success) {
                            displayMarginSuggestions(response);
                            $('#marginSuggestions').slideDown();
                        } else {
                            alert('Error loading suggestions: ' + response.error);
                        }
                    })
                    .fail(function () {
                        alert('Failed to load margin suggestions');
                    })
                    .always(function () {
                        button.prop('disabled', false).html('<i class="fas fa-lightbulb"></i> Get Margin Suggestions');
                    });
            });
        });

        function clearManualInput() {
            $('#ManualMarginInput').val('').trigger('input');
        }
    
        function displayMarginSuggestions(data) {
            const content = `
                <div class="row">
                    <div class="col-md-4">
                        <div class="card border-success">
                            <div class="card-body text-center">
                                <h6 class="text-success">Conservative</h6>
                                <h5>$${data.suggestions.conservative}</h5>
                                <button class="btn btn-sm btn-outline-success" onclick="applySuggestion(${data.suggestions.conservative})">Apply</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-primary">
                            <div class="card-body text-center">
                                <h6 class="text-primary">Market Average</h6>
                                <h5>$${data.suggestions.market}</h5>
                                <small class="text-muted">Based on ${data.comparisonCount} similar licenses</small><br>
                                <button class="btn btn-sm btn-outline-primary" onclick="applySuggestion(${data.suggestions.market})">Apply</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-warning">
                            <div class="card-body text-center">
                                <h6 class="text-warning">Aggressive</h6>
                                <h5>$${data.suggestions.aggressive}</h5>
                                <button class="btn btn-sm btn-outline-warning" onclick="applySuggestion(${data.suggestions.aggressive})">Apply</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            $('#suggestionsContent').html(content);
        }

        function applySuggestion(amount) {
            $('#ManualMarginInput').val(amount.toFixed(2)).trigger('input');
            $('#MarginNotes').val($('#MarginNotes').val() + ' [Applied market suggestion: $' + amount.toFixed(2) + ']');
        }
    </script>
}

@section Styles {
    <style>
        .card-header h5,
        .card-header h6 {
            margin: 0;
        }
        
        #marginPreview {
            min-height: 38px;
            display: flex;
            align-items: center;
        }
        
        .table-borderless td {
            border: none;
            padding: 0.25rem 0.5rem;
        }
    </style>
}