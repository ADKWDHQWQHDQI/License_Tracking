@model License_Tracking.ViewModels.ProjectPipelineViewModel

@{
    ViewData["Title"] = "Create Project Pipeline";
}

<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-plus-circle"></i> Create New Project Pipeline
                    </h3>
                    <p class="mb-0 mt-2">Track future license projects and convert them to actual licenses when
                        confirmed</p>
                </div>
                <div class="card-body">
                    <form asp-action="Create">
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                        <!-- Basic Information -->
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-info-circle"></i> Basic Information
                        </h5>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label asp-for="ProductName" class="form-label" />
                                <input asp-for="ProductName" class="form-control"
                                    placeholder="e.g., Microsoft Office 365" />
                                <sn asp-validation-for="ProductName" class="text-danger"></span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="OemName" class="form-label"></label>
                                <input asp-for="OemName" class="form-control" placeholder="e.g., Microsoft" />
                                <span asp-validation-for="OemName" class="text-danger"></span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="ClientName" class="form-label"></label>
                                <input asp-for="ClientName" class="form-control" placeholder="e.g., ABC Corporation" />
                                <span asp-validation-for="ClientName" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Contact Information -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="ClientContactEmail" class="form-label"></label>
                                <input asp-for="ClientContactEmail" class="form-control" type="email"
                                    placeholder="client@company.com" />
                                <span asp-validation-for="ClientContactEmail" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="ClientContactPhone" class="form-label"></label>
                                <input asp-for="ClientContactPhone" class="form-control" type="tel"
                                    placeholder="+1-xxx-xxx-xxxx" />
                                <span asp-validation-for="ClientContactPhone" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Expected Dates -->
                        <h5 class="text-primary mb-3 mt-4">
                            <i class="fas fa-calendar-alt"></i> Expected Timeline
                        </h5>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="ExpectedLicenseDate" class="form-label"></label>
                                <input asp-for="ExpectedLicenseDate" class="form-control" type="date" />
                                <span asp-validation-for="ExpectedLicenseDate" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="ExpectedExpiryDate" class="form-label"></label>
                                <input asp-for="ExpectedExpiryDate" class="form-control" type="date" />
                                <span asp-validation-for="ExpectedExpiryDate" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Customer Purchase Order -->
                        <h5 class="text-primary mb-3 mt-4">
                            <i class="fas fa-file-invoice"></i> Customer Purchase Order Details
                        </h5>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="CustomerPoNumber" class="form-label"></label>
                                <input asp-for="CustomerPoNumber" class="form-control"
                                    placeholder="e.g., PO-2024-001" />
                                <span asp-validation-for="CustomerPoNumber" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="ExpectedCustomerPoAmount" class="form-label"></label>
                                <input asp-for="ExpectedCustomerPoAmount" class="form-control" type="number" step="0.01"
                                    min="0" />
                                <span asp-validation-for="ExpectedCustomerPoAmount" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label asp-for="CustomerPoItemDescription" class="form-label"></label>
                                <textarea asp-for="CustomerPoItemDescription" class="form-control" rows="2"
                                    placeholder="Describe the expected customer purchase order items..."></textarea>
                                <span asp-validation-for="CustomerPoItemDescription" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- OEM Purchase Order -->
                        <h5 class="text-primary mb-3 mt-4">
                            <i class="fas fa-building"></i> OEM Purchase Order Details
                        </h5>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="OemPoNumber" class="form-label"></label>
                                <input asp-for="OemPoNumber" class="form-control" placeholder="e.g., OEM-PO-2024-001" />
                                <span asp-validation-for="OemPoNumber" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="ExpectedOemPoAmount" class="form-label"></label>
                                <input asp-for="ExpectedOemPoAmount" class="form-control" type="number" step="0.01"
                                    min="0" />
                                <span asp-validation-for="ExpectedOemPoAmount" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label asp-for="OemPoItemDescription" class="form-label"></label>
                                <textarea asp-for="OemPoItemDescription" class="form-control" rows="2"
                                    placeholder="Describe the expected OEM purchase order items..."></textarea>
                                <span asp-validation-for="OemPoItemDescription" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Financial Projections -->
                        <h5 class="text-primary mb-3 mt-4">
                            <i class="fas fa-dollar-sign"></i> Financial Projections
                        </h5>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="ExpectedAmountToReceive" class="form-label"></label>
                                <input asp-for="ExpectedAmountToReceive" class="form-control" type="number" step="0.01"
                                    min="0" />
                                <span asp-validation-for="ExpectedAmountToReceive" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="ExpectedAmountToPay" class="form-label"></label>
                                <input asp-for="ExpectedAmountToPay" class="form-control" type="number" step="0.01"
                                    min="0" />
                                <span asp-validation-for="ExpectedAmountToPay" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Week 10 Enhancement: Advanced Revenue and Margin Calculations -->
                        <h6 class="text-secondary mb-3 mt-3">
                            <i class="fas fa-chart-line"></i>Enhanced Estimations
                        </h6>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="EstimatedRevenue" class="form-label"></label>
                                <input asp-for="EstimatedRevenue" class="form-control" type="number" step="0.01"
                                    min="0" />
                                <span asp-validation-for="EstimatedRevenue" class="text-danger"></span>
                                <small class="form-text text-muted">Projected revenue for this pipeline project</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="EstimatedCost" class="form-label"></label>
                                <input asp-for="EstimatedCost" class="form-control" type="number" step="0.01" min="0" />
                                <span asp-validation-for="EstimatedCost" class="text-danger"></span>
                                <small class="form-text text-muted">Expected total cost</small>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label asp-for="PipelineStage" class="form-label"></label>
                                <select asp-for="PipelineStage" class="form-select">
                                    <option value="Lead">Lead</option>
                                    <option value="Qualified">Qualified</option>
                                    <option value="Proposal">Proposal</option>
                                    <option value="Negotiation">Negotiation</option>
                                    <option value="Closed Won">Closed Won</option>
                                    <option value="Closed Lost">Closed Lost</option>
                                </select>
                                <span asp-validation-for="PipelineStage" class="text-danger"></span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="SuccessProbability" class="form-label"></label>
                                <input asp-for="SuccessProbability" class="form-control" type="number" min="0" max="100"
                                    value="50" />
                                <span asp-validation-for="SuccessProbability" class="text-danger"></span>
                                <small class="form-text text-muted">Probability of project success (0-100%)</small>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="StageConfidenceLevel" class="form-label"></label>
                                <select asp-for="StageConfidenceLevel" class="form-select">
                                    <option value="1">1 - Very Low</option>
                                    <option value="2">2 - Low</option>
                                    <option value="3" selected>3 - Medium</option>
                                    <option value="4">4 - High</option>
                                    <option value="5">5 - Very High</option>
                                </select>
                                <span asp-validation-for="StageConfidenceLevel" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="ExpectedCloseDate" class="form-label"></label>
                                <input asp-for="ExpectedCloseDate" class="form-control" type="date" />
                                <span asp-validation-for="ExpectedCloseDate" class="text-danger"></span>
                                <small class="form-text text-muted">Expected deal closure date</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="ProjectedMarginInput" class="form-label"></label>
                                <input asp-for="ProjectedMarginInput" class="form-control" type="number" step="0.01"
                                    min="0" />
                                <span asp-validation-for="ProjectedMarginInput" class="text-danger"></span>
                                <small class="form-text text-muted">Manual margin override (legacy)</small>
                            </div>
                        </div>

                        <!-- Calculated Values Display -->
                        <div class="row">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-calculator"></i> Calculated Values</h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <strong>Weighted Revenue:</strong>
                                            <span id="weightedRevenue">$0.00</span>
                                        </div>
                                        <div class="col-md-4">
                                            <strong>Margin Percentage:</strong>
                                            <span id="marginPercentage">0.00%</span>
                                        </div>
                                        <div class="col-md-4">
                                            <strong>Risk Adjusted Value:</strong>
                                            <span id="riskAdjustedValue">$0.00</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Invoice and Payment Tracking -->
                        <h5 class="text-primary mb-3 mt-4">
                            <i class="fas fa-file-invoice-dollar"></i> Invoice & Payment Tracking
                        </h5>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label asp-for="ExpectedInvoiceNumber" class="form-label"></label>
                                <input asp-for="ExpectedInvoiceNumber" class="form-control"
                                    placeholder="e.g., INV-2024-001" />
                                <span asp-validation-for="ExpectedInvoiceNumber" class="text-danger"></span>
                                <small class="form-text text-muted">Expected invoice number format</small>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="PaymentStatus" class="form-label"></label>
                                <select asp-for="PaymentStatus" class="form-select">
                                    <option value="Pending">Pending</option>
                                    <option value="Partial">Partial Payment</option>
                                    <option value="Paid">Fully Paid</option>
                                    <option value="Overdue">Overdue</option>
                                </select>
                                <span asp-validation-for="PaymentStatus" class="text-danger"></span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="OemType" class="form-label"></label>
                                <select asp-for="OemType" class="form-select">
                                    <option value="">Select OEM Type</option>
                                    <option value="Direct">Direct OEM</option>
                                    <option value="Distributor">Distributor</option>
                                    <option value="Reseller">Reseller</option>
                                    <option value="Partner">Partner</option>
                                </select>
                                <span asp-validation-for="OemType" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="AmountReceived" class="form-label"></label>
                                <input asp-for="AmountReceived" class="form-control" type="number" step="0.01"
                                    min="0" />
                                <span asp-validation-for="AmountReceived" class="text-danger"></span>
                                <small class="form-text text-muted">Amount received from customer (if any)</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="AmountPaid" class="form-label"></label>
                                <input asp-for="AmountPaid" class="form-control" type="number" step="0.01" min="0" />
                                <span asp-validation-for="AmountPaid" class="text-danger"></span>
                                <small class="form-text text-muted">Amount paid to OEM (if any)</small>
                            </div>
                        </div>

                        <!-- Enhanced Customer Profiling -->
                        <h5 class="text-primary mb-3 mt-4">
                            <i class="fas fa-users"></i> Enhanced Customer Profile
                        </h5>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label asp-for="CustomerType" class="form-label"></label>
                                <select asp-for="CustomerType" class="form-select">
                                    <option value="">Select Customer Type</option>
                                    <option value="Enterprise">Enterprise</option>
                                    <option value="SMB">Small-Medium Business</option>
                                    <option value="Government">Government</option>
                                    <option value="Education">Education</option>
                                    <option value="Healthcare">Healthcare</option>
                                    <option value="Non-Profit">Non-Profit</option>
                                </select>
                                <span asp-validation-for="CustomerType" class="text-danger"></span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="CustomerIndustry" class="form-label"></label>
                                <select asp-for="CustomerIndustry" class="form-select">
                                    <option value="">Select Industry</option>
                                    <option value="Technology">Technology</option>
                                    <option value="Finance">Finance</option>
                                    <option value="Healthcare">Healthcare</option>
                                    <option value="Manufacturing">Manufacturing</option>
                                    <option value="Education">Education</option>
                                    <option value="Retail">Retail</option>
                                    <option value="Government">Government</option>
                                    <option value="Other">Other</option>
                                </select>
                                <span asp-validation-for="CustomerIndustry" class="text-danger"></span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="CustomerEmployeeCount" class="form-label"></label>
                                <input asp-for="CustomerEmployeeCount" class="form-control" type="number" min="1" />
                                <span asp-validation-for="CustomerEmployeeCount" class="text-danger"></span>
                                <small class="form-text text-muted">Approximate employee count</small>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="CustomerWebsite" class="form-label"></label>
                                <input asp-for="CustomerWebsite" class="form-control" type="url"
                                    placeholder="https://www.company.com" />
                                <span asp-validation-for="CustomerWebsite" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="LastCustomerContact" class="form-label"></label>
                                <input asp-for="LastCustomerContact" class="form-control" type="date" />
                                <span asp-validation-for="LastCustomerContact" class="text-danger"></span>
                                <small class="form-text text-muted">Last contact with customer</small>
                            </div>
                        </div>

                        <!-- OEM Relationship -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="OemRelationshipType" class="form-label"></label>
                                <select asp-for="OemRelationshipType" class="form-select">
                                    <option value="">Select Relationship Type</option>
                                    <option value="Direct">Direct OEM Partner</option>
                                    <option value="Partner">Authorized Partner</option>
                                    <option value="Reseller">Reseller</option>
                                    <option value="Distributor">Distributor</option>
                                    <option value="Indirect">Indirect Channel</option>
                                </select>
                                <span asp-validation-for="OemRelationshipType" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="CustomerNotes" class="form-label"></label>
                                <textarea asp-for="CustomerNotes" class="form-control" rows="2"
                                    placeholder="Customer-specific notes, preferences, requirements..."></textarea>
                                <span asp-validation-for="CustomerNotes" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Project Settings -->
                        <h5 class="text-primary mb-3 mt-4">
                            <i class="fas fa-cogs"></i> Project Settings
                        </h5>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label asp-for="AlertDaysBefore" class="form-label"></label>
                                <input asp-for="AlertDaysBefore" class="form-control" type="number" min="1" max="365"
                                    value="45" />
                                <span asp-validation-for="AlertDaysBefore" class="text-danger"></span>
                                <small class="form-text text-muted">Days before expected date to alert</small>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="ProjectStatus" class="form-label"></label>
                                <select asp-for="ProjectStatus" class="form-select">
                                    <option value="Pipeline">Pipeline</option>
                                    <option value="Negotiation">In Negotiation</option>
                                    <option value="Pending">Pending Approval</option>
                                    <option value="Confirmed">Confirmed</option>
                                    <option value="Lost">Lost</option>
                                </select>
                                <span asp-validation-for="ProjectStatus" class="text-danger"></span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="form-check mt-4">
                                    <input asp-for="AlertsEnabled" class="form-check-input" type="checkbox" checked />
                                    <label asp-for="AlertsEnabled" class="form-check-label">
                                        Enable Alerts for this Project
                                    </label>
                                    <span asp-validation-for="AlertsEnabled" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Addresses -->
                        <h5 class="text-primary mb-3 mt-4">
                            <i class="fas fa-map-marker-alt"></i> Address Information
                        </h5>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="ShipToAddress" class="form-label"></label>
                                <textarea asp-for="ShipToAddress" class="form-control" rows="2"
                                    placeholder="Expected shipping address..."></textarea>
                                <span asp-validation-for="ShipToAddress" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="BillToAddress" class="form-label"></label>
                                <textarea asp-for="BillToAddress" class="form-control" rows="2"
                                    placeholder="Expected billing address..."></textarea>
                                <span asp-validation-for="BillToAddress" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="MarginNotes" class="form-label"></label>
                                <textarea asp-for="MarginNotes" class="form-control" rows="3"
                                    placeholder="Add notes about projected margins, special pricing considerations..."></textarea>
                                <span asp-validation-for="MarginNotes" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Remarks" class="form-label"></label>
                                <textarea asp-for="Remarks" class="form-control" rows="3"
                                    placeholder="Additional project notes and remarks..."></textarea>
                                <span asp-validation-for="Remarks" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-between mt-4">
                            <a asp-action="Index" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Back to Pipeline List
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Create Project Pipeline
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        // Week 10 Enhancement: Real-time calculations for enhanced pipeline features
        function updateCalculatedValues() {
            const estimatedRevenue = parseFloat(document.getElementById('EstimatedRevenue')?.value) || 0;
            const estimatedCost = parseFloat(document.getElementById('EstimatedCost')?.value) || 0;
            const successProbability = parseFloat(document.getElementById('SuccessProbability')?.value) || 0;
            const stageConfidence = parseFloat(document.getElementById('StageConfidenceLevel')?.value) || 3;

            // Calculate Week 10 metrics
            const estimatedMargin = estimatedRevenue - estimatedCost;
            const weightedRevenue = estimatedRevenue * (successProbability / 100);
            const marginPercentage = estimatedRevenue > 0 ? (estimatedMargin / estimatedRevenue) * 100 : 0;
            const riskAdjustedValue = weightedRevenue * (stageConfidence / 5);

            // Update display
            document.getElementById('weightedRevenue').textContent = '$' + weightedRevenue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('marginPercentage').textContent = marginPercentage.toFixed(2) + '%';
            document.getElementById('riskAdjustedValue').textContent = '$' + riskAdjustedValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // Auto-calculate projected margin when amounts change (legacy support)
        function updateProjectedMargin() {
            const receiveAmount = parseFloat(document.getElementById('ExpectedAmountToReceive')?.value) || 0;
            const payAmount = parseFloat(document.getElementById('ExpectedAmountToPay')?.value) || 0;
            const margin = receiveAmount - payAmount;

            // Auto-populate EstimatedRevenue and EstimatedCost if they're empty
            const estimatedRevenue = document.getElementById('EstimatedRevenue');
            const estimatedCost = document.getElementById('EstimatedCost');

            if (estimatedRevenue && !estimatedRevenue.value) {
                estimatedRevenue.value = receiveAmount;
            }
            if (estimatedCost && !estimatedCost.value) {
                estimatedCost.value = payAmount;
            }

            updateCalculatedValues();
        }

        // Event listeners for real-time calculations
        document.addEventListener('DOMContentLoaded', function () {
            // Legacy fields
            const receiveAmount = document.getElementById('ExpectedAmountToReceive');
            const payAmount = document.getElementById('ExpectedAmountToPay');

            if (receiveAmount) receiveAmount.addEventListener('input', updateProjectedMargin);
            if (payAmount) payAmount.addEventListener('input', updateProjectedMargin);

            // Week 10 enhanced fields
            const estimatedRevenue = document.getElementById('EstimatedRevenue');
            const estimatedCost = document.getElementById('EstimatedCost');
            const successProbability = document.getElementById('SuccessProbability');
            const stageConfidence = document.getElementById('StageConfidenceLevel');

            if (estimatedRevenue) estimatedRevenue.addEventListener('input', updateCalculatedValues);
            if (estimatedCost) estimatedCost.addEventListener('input', updateCalculatedValues);
            if (successProbability) successProbability.addEventListener('input', updateCalculatedValues);
            if (stageConfidence) stageConfidence.addEventListener('change', updateCalculatedValues);

            // Set default dates
            const today = new Date();
            const futureDate = new Date();
            futureDate.setFullYear(futureDate.getFullYear() + 1);
            const closeDate = new Date();
            closeDate.setMonth(closeDate.getMonth() + 3); // Default close date 3 months from now

            const expectedLicenseDate = document.getElementById('ExpectedLicenseDate');
            const expectedExpiryDate = document.getElementById('ExpectedExpiryDate');
            const expectedCloseDate = document.getElementById('ExpectedCloseDate');

            if (expectedLicenseDate && !expectedLicenseDate.value) {
                expectedLicenseDate.value = today.toISOString().split('T')[0];
            }
            if (expectedExpiryDate && !expectedExpiryDate.value) {
                expectedExpiryDate.value = futureDate.toISOString().split('T')[0];
            }
            if (expectedCloseDate && !expectedCloseDate.value) {
                expectedCloseDate.value = closeDate.toISOString().split('T')[0];
            }

            // Initial calculation
            updateCalculatedValues();
        });
    </script>
}
