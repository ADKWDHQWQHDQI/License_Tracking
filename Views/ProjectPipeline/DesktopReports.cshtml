@{
    ViewData["Title"] = "Desktop Reports - Pipeline Analytics";
}

<!-- Week 10 Enhancement: Comprehensive Desktop Reporting Tools -->
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-chart-bar"></i> Desktop-First Pipeline Reports</h2>
            <p class="text-muted mb-0">Comprehensive desktop-optimized reporting suite with advanced analytics</p>
        </div>
        <div class="btn-group">
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Pipeline
            </a>
            <button class="btn btn-primary" onclick="refreshAllReports()">
                <i class="fas fa-sync-alt"></i> Refresh All
            </button>
            <div class="btn-group">
                <button type="button" class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-download"></i> Export
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" onclick="exportToPDF()"><i class="fas fa-file-pdf"></i> PDF Report</a></li>
                    <li><a class="dropdown-item" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> Excel Report</a></li>
                    <li><a class="dropdown-item" onclick="exportToPowerPoint()"><i class="fas fa-file-powerpoint"></i> PowerPoint</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="text-center my-4" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading reports...</span>
        </div>
        <p class="mt-2">Generating comprehensive reports...</p>
    </div>

    <!-- Executive Summary Cards -->
    <div class="row mb-4" id="executiveSummary">
        <div class="col-xl-3 col-lg-4 col-md-6 mb-3">
            <div class="card analytics-card bg-primary text-white h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-1">Total Pipeline Value</h6>
                            <h3 class="mb-0" id="totalPipelineValue">$0</h3>
                            <small class="text-light" id="pipelineGrowth">+0% vs last month</small>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-chart-line fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-lg-4 col-md-6 mb-3">
            <div class="card analytics-card bg-success text-white h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-1">Weighted Revenue</h6>
                            <h3 class="mb-0" id="weightedRevenue">$0</h3>
                            <small class="text-light" id="conversionRate">0% conversion rate</small>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-balance-scale fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-lg-4 col-md-6 mb-3">
            <div class="card analytics-card bg-info text-white h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-1">Active Deals</h6>
                            <h3 class="mb-0" id="activeDeals">0</h3>
                            <small class="text-light" id="dealVelocity">0 days avg velocity</small>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-handshake fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-lg-4 col-md-6 mb-3">
            <div class="card analytics-card bg-warning text-white h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-1">Success Rate</h6>
                            <h3 class="mb-0" id="successRate">0%</h3>
                            <small class="text-light" id="confidenceLevel">0.0 avg confidence</small>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-target fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Analytics Tabs -->
    <div class="card mb-4">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" id="reportTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                        <i class="fas fa-tachometer-alt"></i> Overview
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="trends-tab" data-bs-toggle="tab" data-bs-target="#trends" type="button" role="tab">
                        <i class="fas fa-chart-area"></i> Trends
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="performance-tab" data-bs-toggle="tab" data-bs-target="#performance" type="button" role="tab">
                        <i class="fas fa-medal"></i> Performance
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="forecasting-tab" data-bs-toggle="tab" data-bs-target="#forecasting" type="button" role="tab">
                        <i class="fas fa-crystal-ball"></i> Forecasting
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="detailed-tab" data-bs-toggle="tab" data-bs-target="#detailed" type="button" role="tab">
                        <i class="fas fa-table"></i> Detailed Data
                    </button>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content" id="reportTabsContent">
                <!-- Overview Tab -->
                <div class="tab-pane fade show active" id="overview" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-chart-pie"></i> Pipeline Distribution by Stage
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="pipelineStageChart" height="300"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-users"></i> Top OEM Partners
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div id="topOemsList">
                                        <!-- Populated via JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-4">
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-chart-bar"></i> Revenue by OEM
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="oemRevenueChart" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-thermometer-half"></i> Pipeline Health
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div id="pipelineHealthMetrics">
                                        <!-- Populated via JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trends Tab -->
                <div class="tab-pane fade" id="trends" role="tabpanel">
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-chart-line"></i> Monthly Pipeline Growth Trends
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="monthlyTrendsChart" height="350"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-4">
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-percentage"></i> Success Rate Trends
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="successRateTrendsChart" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-clock"></i> Deal Velocity Analysis
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="dealVelocityChart" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Tab -->
                <div class="tab-pane fade" id="performance" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-trophy"></i> Performance Scorecard
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div id="performanceScorecard">
                                        <!-- Populated via JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-star"></i> Key Performance Indicators
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div id="kpiMetrics">
                                        <!-- Populated via JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Forecasting Tab -->
                <div class="tab-pane fade" id="forecasting" role="tabpanel">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Note:</strong> Forecasting features focus on estimates and projections only, without predictive algorithms as per business requirements.
                    </div>
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-calendar-alt"></i> Quarterly Projections
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="quarterlyProjectionsChart" height="300"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-calculator"></i> Weighted Revenue Analysis
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div id="weightedRevenueAnalysis">
                                        <!-- Populated via JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Data Tab -->
                <div class="tab-pane fade" id="detailed" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-database"></i> Detailed Pipeline Data
                                </h6>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="exportDetailedData('csv')">
                                        <i class="fas fa-file-csv"></i> CSV
                                    </button>
                                    <button class="btn btn-outline-success" onclick="exportDetailedData('excel')">
                                        <i class="fas fa-file-excel"></i> Excel
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table id="detailedDataTable" class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Product</th>
                                            <th>OEM</th>
                                            <th>Customer</th>
                                            <th>Stage</th>
                                            <th>Est. Revenue</th>
                                            <th>Weighted Revenue</th>
                                            <th>Success %</th>
                                            <th>Confidence</th>
                                            <th>Expected Close</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="detailedDataBody">
                                        <!-- Populated via JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Chart.js for advanced charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // Week 10 Enhancement: Comprehensive Desktop Reporting Suite
        let reportData = null;
        let charts = {};

        // Initialize reporting dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadReportData();
        });

        async function loadReportData() {
            try {
                showLoading(true);
                const response = await fetch('/ProjectPipeline/GetDesktopReportingData');
                reportData = await response.json();
                
                if (reportData.error) {
                    throw new Error(reportData.error);
                }

                updateExecutiveSummary();
                initializeCharts();
                updateDetailedData();
                showLoading(false);
            } catch (error) {
                console.error('Error loading report data:', error);
                showToast('Error loading report data: ' + error.message, 'error');
                showLoading(false);
            }
        }

        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
        }

        function updateExecutiveSummary() {
            if (!reportData) return;

            // Update executive summary cards
            document.getElementById('totalPipelineValue').textContent = 
                new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(reportData.TotalProjects * 50000);
            
            document.getElementById('weightedRevenue').textContent = 
                new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(reportData.ProjectsByOem?.reduce((sum, oem) => sum + (oem.Revenue || 0), 0) || 0);
            
            document.getElementById('activeDeals').textContent = reportData.TotalProjects || 0;
            
            document.getElementById('successRate').textContent = 
                (reportData.PerformanceMetrics?.AverageSuccessRate || 0).toFixed(1) + '%';
        }

        function initializeCharts() {
            // Pipeline Stage Distribution Chart
            if (reportData.ProjectsByStage) {
                const ctx = document.getElementById('pipelineStageChart').getContext('2d');
                charts.stageChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: reportData.ProjectsByStage.map(s => s.Stage),
                        datasets: [{
                            data: reportData.ProjectsByStage.map(s => s.Count),
                            backgroundColor: ['#6c5ce7', '#00b894', '#0984e3', '#fdcb6e', '#e17055', '#a29bfe'],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            // OEM Revenue Chart
            if (reportData.ProjectsByOem) {
                const ctx = document.getElementById('oemRevenueChart').getContext('2d');
                charts.oemChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: reportData.ProjectsByOem.map(o => o.OemName),
                        datasets: [{
                            label: 'Revenue',
                            data: reportData.ProjectsByOem.map(o => o.Revenue),
                            backgroundColor: '#6c5ce7',
                            borderColor: '#5a4fcf',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return new Intl.NumberFormat('en-IN', { 
                                            style: 'currency', 
                                            currency: 'INR',
                                            minimumFractionDigits: 0
                                        }).format(value);
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Monthly Trends Chart
            if (reportData.ProjectsByMonth) {
                const ctx = document.getElementById('monthlyTrendsChart').getContext('2d');
                charts.trendsChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: reportData.ProjectsByMonth.map(m => m.Period),
                        datasets: [{
                            label: 'Projects Count',
                            data: reportData.ProjectsByMonth.map(m => m.Count),
                            borderColor: '#6c5ce7',
                            backgroundColor: 'rgba(108, 92, 231, 0.1)',
                            tension: 0.4
                        }, {
                            label: 'Revenue',
                            data: reportData.ProjectsByMonth.map(m => m.Revenue),
                            borderColor: '#00b894',
                            backgroundColor: 'rgba(0, 184, 148, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                grid: {
                                    drawOnChartArea: false,
                                },
                            }
                        }
                    }
                });
            }
        }

        function updateDetailedData() {
            // This would typically load from the pipeline data
            // For now, we'll show a placeholder
            const tbody = document.getElementById('detailedDataBody');
            tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">Loading detailed data...</td></tr>';
        }

        function refreshAllReports() {
            // Destroy existing charts
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};
            
            // Reload data
            loadReportData();
            showToast('Reports refreshed successfully!', 'success');
        }

        function exportToPDF() {
            showToast('PDF export functionality coming soon!', 'info');
        }

        function exportToExcel() {
            window.location.href = '/ProjectPipeline/ExportToExcel';
        }

        function exportToPowerPoint() {
            showToast('PowerPoint export functionality coming soon!', 'info');
        }

        function exportDetailedData(format) {
            showToast(`${format.toUpperCase()} export functionality coming soon!`, 'info');
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 4000);
        }
    </script>
}
