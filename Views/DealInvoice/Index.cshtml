@model object
@{
    ViewData["Title"] = "Deal Invoice Management";
    var deal = ViewBag.Deal as License_Tracking.Models.Deal;
}

<!-- Bigin.com-inspired Deal Invoice Management Dashboard -->
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row">
        <div class="col-12">
            <div class="bigin-page-header mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="bigin-breadcrumb">
                            <a asp-controller="Deals" asp-action="Index" class="text-decoration-none text-muted">
                                <i class="fas fa-handshake"></i> Deals
                            </a>
                            <span class="mx-2 text-muted">›</span>
                            <span class="text-primary">@deal!.DealName</span>
                            <span class="mx-2 text-muted">›</span>
                            <span>Invoice Management</span>
                        </div>
                        <h1 class="bigin-page-title">
                            <i class="fas fa-file-invoice-dollar text-primary"></i>
                            Multi-Invoice System
                        </h1>
                        <p class="text-muted mb-0">Phase-specific invoice generation and payment tracking</p>
                    </div>
                    <div class="bigin-action-buttons">
                        <a asp-controller="Deals" asp-action="Details" asp-route-id="@deal.DealId" class="btn bigin-btn-outline-primary">
                            <i class="fas fa-arrow-left"></i> Back to Deal
                        </a>
                        <button type="button" class="btn bigin-btn-success" data-bs-toggle="modal" data-bs-target="#generateInvoiceModal">
                            <i class="fas fa-plus"></i> Generate Invoice
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Deal Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="bigin-card bigin-metric-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="bigin-metric-icon bg-primary">
                            <i class="fas fa-building"></i>
                        </div>
                        <div class="ms-3">
                            <h6 class="mb-0">@deal.Company?.CompanyName</h6>
                            <small class="text-muted">Customer</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="bigin-card bigin-metric-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="bigin-metric-icon bg-info">
                            <i class="fas fa-layer-group"></i>
                        </div>
                        <div class="ms-3">
                            <h6 class="mb-0">@deal.CurrentPhase</h6>
                            <small class="text-muted">Current Phase</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="bigin-card bigin-metric-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="bigin-metric-icon bg-success">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="ms-3">
                            <h6 class="mb-0">@deal.CustomerInvoiceAmount?.ToString("C")</h6>
                            <small class="text-muted">Deal Value</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="bigin-card bigin-metric-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="bigin-metric-icon bg-warning">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="ms-3">
                            <h6 class="mb-0">@deal.Margin.ToString("C")</h6>
                            <small class="text-muted">Expected Margin</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Phase-Specific Invoice Management -->
    <div class="row">
        <div class="col-12">
            <div class="bigin-card">
                <div class="card-header bigin-card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-file-invoice text-primary"></i> Phase-Specific Invoices
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Phase Navigation Tabs -->
                    <ul class="nav nav-pills bigin-nav-pills mb-4" id="phaseTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="phase1-tab" data-bs-toggle="pill" data-bs-target="#phase1" type="button" role="tab">
                                <i class="fas fa-handshake"></i> Phase 1 - Customer Billing
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="phase2-tab" data-bs-toggle="pill" data-bs-target="#phase2" type="button" role="tab">
                                <i class="fas fa-shopping-cart"></i> Phase 2 - OEM Procurement
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="phase4-tab" data-bs-toggle="pill" data-bs-target="#phase4" type="button" role="tab">
                                <i class="fas fa-credit-card"></i> Phase 4 - OEM Settlement
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="phaseTabContent">
                        <!-- Phase 1: Customer to Canarys -->
                        <div class="tab-pane fade show active" id="phase1" role="tabpanel">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="bigin-card bigin-phase-card">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="mb-0">
                                                <i class="fas fa-handshake"></i> Phase 1: Customer to Canarys
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            @if (!string.IsNullOrEmpty(deal.CustomerInvoiceNumber))
                                            {
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <div>
                                                        <h6 class="mb-1">Invoice: @deal.CustomerInvoiceNumber</h6>
                                                        <p class="text-muted mb-0">Amount: @deal.CustomerInvoiceAmount?.ToString("C")</p>
                                                    </div>
                                                    <span class="badge bg-@GetPaymentStatusColor(deal.CustomerPaymentStatus) fs-6">
                                                        @(deal.CustomerPaymentStatus ?? "Pending")
                                                    </span>
                                                </div>
                                                
                                                @if (deal.CustomerPaymentStatus != "Paid")
                                                {
                                                    <button type="button" class="btn bigin-btn-success" onclick="recordPayment('@deal.CustomerInvoiceNumber', @deal.CustomerInvoiceAmount, 'Customer_To_Canarys')">
                                                        <i class="fas fa-money-check-alt"></i> Record Payment
                                                    </button>
                                                }
                                                else
                                                {
                                                    <div class="alert alert-success">
                                                        <i class="fas fa-check-circle"></i> Payment completed on @deal.CustomerPaymentDate?.ToString("MMM dd, yyyy")
                                                    </div>
                                                }
                                            }
                                            else
                                            {
                                                <div class="text-center py-4">
                                                    <i class="fas fa-file-invoice fa-3x text-muted mb-3"></i>
                                                    <h6 class="text-muted">No customer invoice generated</h6>
                                                    <button type="button" class="btn bigin-btn-primary" onclick="generatePhaseInvoice('Customer_To_Canarys', @deal.CustomerInvoiceAmount)">
                                                        <i class="fas fa-plus"></i> Generate Customer Invoice
                                                    </button>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="bigin-info-card">
                                        <h6 class="text-primary mb-3">
                                            <i class="fas fa-info-circle"></i> Phase 1 Details
                                        </h6>
                                        <div class="mb-2">
                                            <strong>Customer PO:</strong><br>
                                            <span class="text-muted">@(deal.CustomerPoNumber ?? "Not received")</span>
                                        </div>
                                        <div class="mb-2">
                                            <strong>PO Date:</strong><br>
                                            <span class="text-muted">@(deal.CustomerPoDate?.ToString("MMM dd, yyyy") ?? "Pending")</span>
                                        </div>
                                        <div class="mb-2">
                                            <strong>Expected Amount:</strong><br>
                                            <span class="text-success fw-bold">@deal.CustomerInvoiceAmount?.ToString("C")</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Phase 2: Canarys to OEM -->
                        <div class="tab-pane fade" id="phase2" role="tabpanel">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="bigin-card bigin-phase-card">
                                        <div class="card-header bg-info text-white">
                                            <h6 class="mb-0">
                                                <i class="fas fa-shopping-cart"></i> Phase 2: Canarys to OEM
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            @if (!string.IsNullOrEmpty(deal.CanarysPoNumber))
                                            {
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <div>
                                                        <h6 class="mb-1">PO: @deal.CanarysPoNumber</h6>
                                                        <p class="text-muted mb-0">Amount: @deal.OemQuoteAmount?.ToString("C")</p>
                                                    </div>
                                                    <span class="badge bg-success fs-6">Sent to OEM</span>
                                                </div>
                                                
                                                <div class="alert alert-info">
                                                    <i class="fas fa-info-circle"></i> PO sent to @deal.Oem?.OemName on @deal.CanarysPoDate?.ToString("MMM dd, yyyy")
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="text-center py-4">
                                                    <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                                                    <h6 class="text-muted">No OEM purchase order created</h6>
                                                    <p class="text-muted">Phase 2 procurement is pending</p>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="bigin-info-card">
                                        <h6 class="text-info mb-3">
                                            <i class="fas fa-info-circle"></i> Phase 2 Details
                                        </h6>
                                        <div class="mb-2">
                                            <strong>OEM Partner:</strong><br>
                                            <span class="text-muted">@(deal.Oem?.OemName ?? "Not selected")</span>
                                        </div>
                                        <div class="mb-2">
                                            <strong>Quote Amount:</strong><br>
                                            <span class="text-info fw-bold">@deal.OemQuoteAmount?.ToString("C")</span>
                                        </div>
                                        <div class="mb-2">
                                            <strong>Expected Margin:</strong><br>
                                            <span class="text-success fw-bold">@deal.EstimatedMargin?.ToString("C")</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Phase 4: OEM to Canarys -->
                        <div class="tab-pane fade" id="phase4" role="tabpanel">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="bigin-card bigin-phase-card">
                                        <div class="card-header bg-warning text-dark">
                                            <h6 class="mb-0">
                                                <i class="fas fa-credit-card"></i> Phase 4: OEM to Canarys
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            @if (!string.IsNullOrEmpty(deal.OemInvoiceNumber))
                                            {
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <div>
                                                        <h6 class="mb-1">Invoice: @deal.OemInvoiceNumber</h6>
                                                        <p class="text-muted mb-0">Amount: @deal.OemInvoiceAmount?.ToString("C")</p>
                                                    </div>
                                                    <span class="badge bg-@GetPaymentStatusColor(deal.OemPaymentStatus) fs-6">
                                                        @(deal.OemPaymentStatus ?? "Pending")
                                                    </span>
                                                </div>
                                                
                                                @if (deal.OemPaymentStatus != "Paid")
                                                {
                                                    <button type="button" class="btn bigin-btn-warning" onclick="recordPayment('@deal.OemInvoiceNumber', @deal.OemInvoiceAmount, 'OEM_To_Canarys')">
                                                        <i class="fas fa-credit-card"></i> Record OEM Payment
                                                    </button>
                                                }
                                                else
                                                {
                                                    <div class="alert alert-success">
                                                        <i class="fas fa-check-circle"></i> Payment completed on @deal.OemPaymentDate?.ToString("MMM dd, yyyy")
                                                    </div>
                                                }
                                            }
                                            else
                                            {
                                                <div class="text-center py-4">
                                                    <i class="fas fa-file-invoice fa-3x text-muted mb-3"></i>
                                                    <h6 class="text-muted">No OEM invoice received</h6>
                                                    <p class="text-muted">Waiting for OEM to generate invoice</p>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="bigin-info-card">
                                        <h6 class="text-warning mb-3">
                                            <i class="fas fa-info-circle"></i> Phase 4 Details
                                        </h6>
                                        <div class="mb-2">
                                            <strong>License Delivered:</strong><br>
                                            <span class="text-muted">@(deal.LicenseStartDate?.ToString("MMM dd, yyyy") ?? "Pending")</span>
                                        </div>
                                        <div class="mb-2">
                                            <strong>License End Date:</strong><br>
                                            <span class="text-muted">@(deal.LicenseEndDate?.ToString("MMM dd, yyyy") ?? "Pending")</span>
                                        </div>
                                        <div class="mb-2">
                                            <strong>Settlement Amount:</strong><br>
                                            <span class="text-warning fw-bold">@deal.OemInvoiceAmount?.ToString("C")</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice List -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="bigin-card">
                <div class="card-header bigin-card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-list text-primary"></i> Invoice History
                        </h5>
                        <a asp-action="ExportInvoiceReport" asp-route-dealId="@deal.DealId" class="btn bigin-btn-outline-secondary">
                            <i class="fas fa-download"></i> Export Report
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    @if (deal.Invoices?.Any() == true)
                    {
                        <div class="table-responsive">
                            <table class="table table-hover bigin-table">
                                <thead>
                                    <tr>
                                        <th>Invoice #</th>
                                        <th>Type</th>
                                        <th>Date</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var invoice in deal.Invoices)
                                    {
                                        <tr>
                                            <td>
                                                <strong>@invoice.InvoiceNumber</strong>
                                            </td>
                                            <td>
                                                <span class="badge bg-@GetInvoiceTypeColor(invoice.InvoiceType)">
                                                    @invoice.InvoiceType.Replace("_", " ")
                                                </span>
                                            </td>
                                            <td>@invoice.InvoiceDate.ToString("MMM dd, yyyy")</td>
                                            <td class="fw-bold text-success">@invoice.TotalAmount.ToString("C")</td>
                                            <td>
                                                <span class="badge bg-@GetPaymentStatusColor(invoice.PaymentStatus)">
                                                    @invoice.PaymentStatus
                                                </span>
                                            </td>
                                            <td>
                                                <a asp-action="InvoiceDetails" asp-route-invoiceId="@invoice.InvoiceId" class="btn btn-sm bigin-btn-outline-primary">
                                                    <i class="fas fa-eye"></i> View
                                                </a>
                                                @if (invoice.PaymentStatus != "Paid")
                                                {
                                                    <button type="button" class="btn btn-sm bigin-btn-outline-success ms-1" 
                                                            onclick="recordPayment('@invoice.InvoiceNumber', @invoice.TotalAmount, '@invoice.InvoiceType')">
                                                        <i class="fas fa-money-check-alt"></i> Payment
                                                    </button>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="fas fa-file-invoice fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No invoices generated yet</h5>
                            <p class="text-muted">Start by generating your first phase-specific invoice</p>
                            <button type="button" class="btn bigin-btn-primary" data-bs-toggle="modal" data-bs-target="#generateInvoiceModal">
                                <i class="fas fa-plus"></i> Generate First Invoice
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Generate Invoice Modal -->
<div class="modal fade" id="generateInvoiceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bigin-modal">
            <div class="modal-header bigin-modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-invoice text-primary"></i> Generate Phase Invoice
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form asp-action="GeneratePhaseInvoice" method="post">
                <input type="hidden" name="dealId" value="@deal.DealId" />
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Invoice Type</label>
                                <select name="invoiceType" class="form-select" required>
                                    <option value="">Select Type</option>
                                    <option value="Customer_To_Canarys">Phase 1 - Customer to Canarys</option>
                                    <option value="Canarys_To_OEM">Phase 2 - Canarys to OEM</option>
                                    <option value="OEM_To_Canarys">Phase 4 - OEM to Canarys</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Amount</label>
                                <input type="number" name="amount" step="0.01" class="form-control" required placeholder="0.00">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Due Date</label>
                        <input type="date" name="dueDate" class="form-control" required value="@DateTime.Now.AddDays(30).ToString("yyyy-MM-dd")">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea name="notes" class="form-control" rows="3" placeholder="Invoice notes or reference"></textarea>
                    </div>
                </div>
                <div class="modal-footer bigin-modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn bigin-btn-success">
                        <i class="fas fa-file-invoice"></i> Generate Invoice
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Record Payment Modal -->
<div class="modal fade" id="recordPaymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bigin-modal">
            <div class="modal-header bigin-modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-money-check-alt text-success"></i> Record Payment
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form asp-action="RecordPayment" method="post">
                <input type="hidden" name="invoiceId" id="paymentInvoiceId" />
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Invoice Number</label>
                        <input type="text" id="paymentInvoiceNumber" class="form-control" readonly>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Payment Amount</label>
                                <input type="number" name="paymentAmount" id="paymentAmount" step="0.01" class="form-control" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Payment Date</label>
                                <input type="date" name="paymentDate" class="form-control" required value="@DateTime.Now.ToString("yyyy-MM-dd")">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Payment Method</label>
                        <select name="paymentMethod" class="form-select" required>
                            <option value="">Select Method</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Check">Check</option>
                            <option value="Credit Card">Credit Card</option>
                            <option value="Cash">Cash</option>
                            <option value="ACH">ACH</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reference</label>
                        <input type="text" name="reference" class="form-control" placeholder="Transaction reference or notes">
                    </div>
                </div>
                <div class="modal-footer bigin-modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn bigin-btn-success">
                        <i class="fas fa-money-check-alt"></i> Record Payment
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@functions {
    string GetPaymentStatusColor(string? status)
    {
        return status switch
        {
            "Paid" => "success",
            "Partial" => "warning",
            "Pending" => "secondary",
            "Overdue" => "danger",
            _ => "secondary"
        };
    }

    string GetInvoiceTypeColor(string type)
    {
        return type switch
        {
            "Customer_To_Canarys" => "primary",
            "Canarys_To_OEM" => "info",
            "OEM_To_Canarys" => "warning",
            _ => "secondary"
        };
    }
}

<script>
function generatePhaseInvoice(invoiceType, amount) {
    $('select[name="invoiceType"]').val(invoiceType);
    $('input[name="amount"]').val(amount);
    $('#generateInvoiceModal').modal('show');
}

function recordPayment(invoiceNumber, amount, invoiceType) {
    $('#paymentInvoiceNumber').val(invoiceNumber);
    $('#paymentAmount').val(amount);
    $('#recordPaymentModal').modal('show');
}
</script>

<style>
.bigin-phase-card {
    border-left: 4px solid var(--bs-primary);
}

.bigin-info-card {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    border: 1px solid #e9ecef;
}

.bigin-metric-card {
    transition: all 0.3s ease;
}

.bigin-metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

.bigin-metric-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 20px;
}

.bigin-nav-pills .nav-link {
    border-radius: 25px;
    margin-right: 10px;
    transition: all 0.3s ease;
}

.bigin-nav-pills .nav-link.active {
    background: linear-gradient(135deg, #6c5ce7 0%, #5a67d8 100%);
    color: white;
}
</style>
