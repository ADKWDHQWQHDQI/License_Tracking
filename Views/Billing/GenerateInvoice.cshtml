@{
    ViewData["Title"] = "Generate Invoice";
}

<div class="container">
    <h2><i class="fas fa-file-invoice"></i> Generate Invoice</h2>

    @if (!ViewData.ModelState.IsValid)
    {
        <div class="alert alert-danger">
            <div asp-validation-summary="All"></div>
        </div>
    }

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-plus-circle"></i> Create New Invoice
                    </h5>
                </div>
                <div class="card-body">
                    <form asp-action="GenerateInvoice" method="post">
                        @Html.AntiForgeryToken()

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Source Type</label>
                                <select id="sourceType" class="form-control" onchange="toggleSourceOptions()">
                                    <option value="license">License</option>
                                    <option value="pipeline">Project Pipeline</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Invoice Type</label>
                                <select name="invoiceType" class="form-control" required>
                                    <option value="Customer">Customer Invoice (Revenue)</option>
                                    <option value="OEM">OEM Invoice (Cost)</option>
                                </select>
                            </div>
                        </div>

                        <div id="licenseSection" class="mb-3">
                            <label class="form-label">License</label>
                            <select asp-items="ViewBag.Licenses" name="licenseId" class="form-control">
                                <option value="">Select a License</option>
                            </select>
                        </div>

                        <div id="pipelineSection" class="mb-3" style="display: none;">
                            <label class="form-label">Project Pipeline</label>
                            <select asp-items="ViewBag.ProjectPipelines" name="projectPipelineId" class="form-control">
                                <option value="">Select a Pipeline Project</option>
                            </select>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Invoice Number</label>
                                <input name="invoiceNumber" class="form-control" placeholder="e.g., INV-2025-001"
                                    required />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Vendor/Client Name</label>
                                <input name="vendorName" class="form-control"
                                    placeholder="For OEM: OEM Name, For Customer: Client Name" />
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Amount</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input name="amount" class="form-control" type="number" step="0.01" min="0"
                                        required />
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Due Date</label>
                                <input name="dueDate" class="form-control" type="date" required />
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea name="description" class="form-control" rows="3"
                                placeholder="Invoice description..."></textarea>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a asp-action="PaymentStatus" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Back to Payment Status
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Generate Invoice
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-info-circle"></i> Dual Invoice System
                    </h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-3">
                        <strong>Customer Invoice:</strong><br>
                        • Tracks revenue from clients<br>
                        • Uses selling price<br>
                        • Sent to customers
                    </div>
                    <div class="alert alert-warning mb-3">
                        <strong>OEM Invoice:</strong><br>
                        • Tracks costs from vendors<br>
                        • Uses cost price<br>
                        • Internal cost tracking
                    </div>
                    <div class="alert alert-success">
                        <strong>Auto-Generate:</strong><br>
                        Use quick actions in Payment Status to auto-generate invoices from existing licenses.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        function toggleSourceOptions() {
            const sourceType = document.getElementById('sourceType').value;
            const licenseSection = document.getElementById('licenseSection');
            const pipelineSection = document.getElementById('pipelineSection');

            if (sourceType === 'license') {
                licenseSection.style.display = 'block';
                pipelineSection.style.display = 'none';
                document.querySelector('select[name="licenseId"]').setAttribute('required', 'required');
                document.querySelector('select[name="projectPipelineId"]').removeAttribute('required');
            } else {
                licenseSection.style.display = 'none';
                pipelineSection.style.display = 'block';
                document.querySelector('select[name="licenseId"]').removeAttribute('required');
                document.querySelector('select[name="projectPipelineId"]').setAttribute('required', 'required');
            }
        }

        // Set default due date to 30 days from today
        document.addEventListener('DOMContentLoaded', function () {
            const dueDateInput = document.querySelector('input[name="dueDate"]');
            const today = new Date();
            const futureDate = new Date(today.getTime() + (30 * 24 * 60 * 60 * 1000));
            dueDateInput.value = futureDate.toISOString().split('T')[0];
        });
    </script>
}
 