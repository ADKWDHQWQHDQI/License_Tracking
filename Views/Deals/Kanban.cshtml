@model IEnumerable<License_Tracking.Models.Deal>

@{
    ViewData["Title"] = "Deal Pipeline - Kanban View";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Bigin.com-Style Kanban Pipeline View -->
<div class="bigin-kanban-container">
    <!-- Header -->
    <div class="kanban-header mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="bigin-page-title">
                    <i class="fas fa-columns"></i> Deal Pipeline
                </h1>
                <p class="bigin-subtitle mb-0">Kanban view - Visual deal progression tracking</p>
            </div>
            <div class="d-flex gap-2">
                <a asp-action="Create" class="btn btn-success bigin-btn-primary">
                    <i class="fas fa-plus"></i> New Deal
                </a>
            </div>
        </div>
    </div>

    <!-- View Toggle Bar -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-light border-0">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-center">
                        <div class="btn-group shadow-sm" role="group" aria-label="View options">
                            <a asp-action="Index" class="btn btn-outline-primary">
                                <i class="fas fa-list me-2"></i>List View
                            </a>
                            <button type="button" class="btn btn-primary active">
                                <i class="fas fa-columns me-2"></i>Kanban View
                            </button>
                            <a asp-action="Sheet" class="btn btn-outline-primary">
                                <i class="fas fa-table me-2"></i>Sheet View
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Kanban Pipeline Stats -->
    <div class="kanban-stats mb-4">
        <div class="row">
            <div class="col-md-3">
                <div class="bigin-stat-card bg-gradient-primary">
                    <div class="stat-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-content">
                        <h3 class="stat-number">@Model.Count()</h3>
                        <p class="stat-label">Total Deals</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="bigin-stat-card bg-gradient-success">
                    <div class="stat-icon">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-content">
                        <h3 class="stat-number">@(Model.Where(d => d.CustomerInvoiceAmount.HasValue).Sum(d => d.CustomerInvoiceAmount!.Value).ToString("C0"))</h3>
                        <p class="stat-label">Pipeline Value</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="bigin-stat-card bg-gradient-warning">
                    <div class="stat-icon">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <div class="stat-content">
                        <h3 class="stat-number">@Model.Count(d => d.DealStage == "Won")</h3>
                        <p class="stat-label">Won Deals</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="bigin-stat-card bg-gradient-info">
                    <div class="stat-icon">
                        <i class="fas fa-percentage"></i>
                    </div>
                    <div class="stat-content">
                        <h3 class="stat-number">@(Model.Any() ? Math.Round((double)Model.Count(d => d.DealStage == "Won") / Model.Count() * 100, 1) : 0)%</h3>
                        <p class="stat-label">Win Rate</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Kanban Board -->
    <div class="kanban-board">
        <div class="kanban-columns">
            <!-- Lead Column -->
            <div class="kanban-column" data-stage="Lead">
                <div class="kanban-column-header bg-gradient-primary">
                    <div class="column-title">
                        <i class="fas fa-user-plus"></i>
                        <span>Lead</span>
                    </div>
                    <div class="column-count">@Model.Count(d => d.DealStage == "Lead")</div>
                </div>
                <div class="kanban-column-body" id="leadColumn">
                    @foreach (var deal in Model.Where(d => d.DealStage == "Lead"))
                    {
                        <div class="kanban-card" data-deal-id="@deal.DealId" draggable="true">
                            <div class="kanban-card-header">
                                <h6 class="card-title">@deal.DealName</h6>
                                <div class="card-actions">
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" asp-action="Details" asp-route-id="@deal.DealId">
                                                <i class="fas fa-eye"></i> View Details</a></li>
                                            <li><a class="dropdown-item" asp-action="Edit" asp-route-id="@deal.DealId">
                                                <i class="fas fa-edit"></i> Edit Deal</a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item text-success" onclick="moveToStage(@deal.DealId, 'Qualified')">
                                                <i class="fas fa-arrow-right"></i> Move to Qualified</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="kanban-card-body">
                                <div class="card-company">
                                    <i class="fas fa-building"></i>
                                    @deal.Company?.CompanyName
                                </div>
                                <div class="card-product">
                                    <i class="fas fa-cube"></i>
                                    @deal.Product?.ProductName
                                </div>
                                <div class="card-value">
                                    <i class="fas fa-dollar-sign"></i>
                                    @(deal.CustomerInvoiceAmount?.ToString("C0") ?? "TBD")
                                </div>
                                <div class="card-assignee">
                                    <i class="fas fa-user"></i>
                                    @(deal.AssignedTo ?? "Unassigned")
                                </div>
                            </div>
                            <div class="kanban-card-footer">
                                <div class="card-priority priority-@deal.Priority?.ToLower()">
                                    @deal.Priority
                                </div>
                                <div class="card-date">
                                    @deal.ExpectedCloseDate?.ToString("MMM dd")
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Qualified Column -->
            <div class="kanban-column" data-stage="Qualified">
                <div class="kanban-column-header bg-gradient-info">
                    <div class="column-title">
                        <i class="fas fa-check-circle"></i>
                        <span>Qualified</span>
                    </div>
                    <div class="column-count">@Model.Count(d => d.DealStage == "Qualified")</div>
                </div>
                <div class="kanban-column-body" id="qualifiedColumn">
                    @foreach (var deal in Model.Where(d => d.DealStage == "Qualified"))
                    {
                        <div class="kanban-card" data-deal-id="@deal.DealId" draggable="true">
                            <div class="kanban-card-header">
                                <h6 class="card-title">@deal.DealName</h6>
                                <div class="card-actions">
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" asp-action="Details" asp-route-id="@deal.DealId">
                                                <i class="fas fa-eye"></i> View Details</a></li>
                                            <li><a class="dropdown-item" asp-action="Edit" asp-route-id="@deal.DealId">
                                                <i class="fas fa-edit"></i> Edit Deal</a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item text-warning" onclick="moveToStage(@deal.DealId, 'Lead')">
                                                <i class="fas fa-arrow-left"></i> Move to Lead</a></li>
                                            <li><a class="dropdown-item text-success" onclick="moveToStage(@deal.DealId, 'Quoted')">
                                                <i class="fas fa-arrow-right"></i> Move to Quoted</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="kanban-card-body">
                                <div class="card-company">
                                    <i class="fas fa-building"></i>
                                    @deal.Company?.CompanyName
                                </div>
                                <div class="card-product">
                                    <i class="fas fa-cube"></i>
                                    @deal.Product?.ProductName
                                </div>
                                <div class="card-value">
                                    <i class="fas fa-dollar-sign"></i>
                                    @(deal.CustomerInvoiceAmount?.ToString("C0") ?? "TBD")
                                </div>
                                <div class="card-assignee">
                                    <i class="fas fa-user"></i>
                                    @(deal.AssignedTo ?? "Unassigned")
                                </div>
                            </div>
                            <div class="kanban-card-footer">
                                <div class="card-priority priority-@deal.Priority?.ToLower()">
                                    @deal.Priority
                                </div>
                                <div class="card-date">
                                    @deal.ExpectedCloseDate?.ToString("MMM dd")
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Quoted Column -->
            <div class="kanban-column" data-stage="Quoted">
                <div class="kanban-column-header bg-gradient-warning">
                    <div class="column-title">
                        <i class="fas fa-file-invoice"></i>
                        <span>Quoted</span>
                    </div>
                    <div class="column-count">@Model.Count(d => d.DealStage == "Quoted")</div>
                </div>
                <div class="kanban-column-body" id="quotedColumn">
                    @foreach (var deal in Model.Where(d => d.DealStage == "Quoted"))
                    {
                        <div class="kanban-card" data-deal-id="@deal.DealId" draggable="true">
                            <div class="kanban-card-header">
                                <h6 class="card-title">@deal.DealName</h6>
                                <div class="card-actions">
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" asp-action="Details" asp-route-id="@deal.DealId">
                                                <i class="fas fa-eye"></i> View Details</a></li>
                                            <li><a class="dropdown-item" asp-action="Edit" asp-route-id="@deal.DealId">
                                                <i class="fas fa-edit"></i> Edit Deal</a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item text-warning" onclick="moveToStage(@deal.DealId, 'Qualified')">
                                                <i class="fas fa-arrow-left"></i> Move to Qualified</a></li>
                                            <li><a class="dropdown-item text-success" onclick="moveToStage(@deal.DealId, 'Negotiation')">
                                                <i class="fas fa-arrow-right"></i> Move to Negotiation</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="kanban-card-body">
                                <div class="card-company">
                                    <i class="fas fa-building"></i>
                                    @deal.Company?.CompanyName
                                </div>
                                <div class="card-product">
                                    <i class="fas fa-cube"></i>
                                    @deal.Product?.ProductName
                                </div>
                                <div class="card-value">
                                    <i class="fas fa-dollar-sign"></i>
                                    @(deal.CustomerInvoiceAmount?.ToString("C0") ?? "TBD")
                                </div>
                                <div class="card-assignee">
                                    <i class="fas fa-user"></i>
                                    @(deal.AssignedTo ?? "Unassigned")
                                </div>
                            </div>
                            <div class="kanban-card-footer">
                                <div class="card-priority priority-@deal.Priority?.ToLower()">
                                    @deal.Priority
                                </div>
                                <div class="card-date">
                                    @deal.ExpectedCloseDate?.ToString("MMM dd")
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Negotiation Column -->
            <div class="kanban-column" data-stage="Negotiation">
                <div class="kanban-column-header bg-gradient-secondary">
                    <div class="column-title">
                        <i class="fas fa-handshake"></i>
                        <span>Negotiation</span>
                    </div>
                    <div class="column-count">@Model.Count(d => d.DealStage == "Negotiation")</div>
                </div>
                <div class="kanban-column-body" id="negotiationColumn">
                    @foreach (var deal in Model.Where(d => d.DealStage == "Negotiation"))
                    {
                        <div class="kanban-card" data-deal-id="@deal.DealId" draggable="true">
                            <div class="kanban-card-header">
                                <h6 class="card-title">@deal.DealName</h6>
                                <div class="card-actions">
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" asp-action="Details" asp-route-id="@deal.DealId">
                                                <i class="fas fa-eye"></i> View Details</a></li>
                                            <li><a class="dropdown-item" asp-action="Edit" asp-route-id="@deal.DealId">
                                                <i class="fas fa-edit"></i> Edit Deal</a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item text-warning" onclick="moveToStage(@deal.DealId, 'Quoted')">
                                                <i class="fas fa-arrow-left"></i> Move to Quoted</a></li>
                                            <li><a class="dropdown-item text-success" onclick="moveToStage(@deal.DealId, 'Won')">
                                                <i class="fas fa-arrow-right"></i> Close as Won</a></li>
                                            <li><a class="dropdown-item text-danger" onclick="moveToStage(@deal.DealId, 'Lost')">
                                                <i class="fas fa-times"></i> Mark as Lost</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="kanban-card-body">
                                <div class="card-company">
                                    <i class="fas fa-building"></i>
                                    @deal.Company?.CompanyName
                                </div>
                                <div class="card-product">
                                    <i class="fas fa-cube"></i>
                                    @deal.Product?.ProductName
                                </div>
                                <div class="card-value">
                                    <i class="fas fa-dollar-sign"></i>
                                    @(deal.CustomerInvoiceAmount?.ToString("C0") ?? "TBD")
                                </div>
                                <div class="card-assignee">
                                    <i class="fas fa-user"></i>
                                    @(deal.AssignedTo ?? "Unassigned")
                                </div>
                            </div>
                            <div class="kanban-card-footer">
                                <div class="card-priority priority-@deal.Priority?.ToLower()">
                                    @deal.Priority
                                </div>
                                <div class="card-date">
                                    @deal.ExpectedCloseDate?.ToString("MMM dd")
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Won Column -->
            <div class="kanban-column" data-stage="Won">
                <div class="kanban-column-header bg-gradient-success">
                    <div class="column-title">
                        <i class="fas fa-trophy"></i>
                        <span>Won</span>
                    </div>
                    <div class="column-count">@Model.Count(d => d.DealStage == "Won")</div>
                </div>
                <div class="kanban-column-body" id="wonColumn">
                    @foreach (var deal in Model.Where(d => d.DealStage == "Won"))
                    {
                        <div class="kanban-card kanban-card-won" data-deal-id="@deal.DealId">
                            <div class="kanban-card-header">
                                <h6 class="card-title">@deal.DealName</h6>
                                <div class="card-actions">
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" asp-action="Details" asp-route-id="@deal.DealId">
                                                <i class="fas fa-eye"></i> View Details</a></li>
                                            <li><a class="dropdown-item" asp-action="Edit" asp-route-id="@deal.DealId">
                                                <i class="fas fa-edit"></i> Edit Deal</a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item" asp-controller="InvoiceManagement" asp-action="Index" asp-route-dealId="@deal.DealId">
                                                <i class="fas fa-file-invoice-dollar"></i> Manage Invoices</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="kanban-card-body">
                                <div class="card-company">
                                    <i class="fas fa-building"></i>
                                    @deal.Company?.CompanyName
                                </div>
                                <div class="card-product">
                                    <i class="fas fa-cube"></i>
                                    @deal.Product?.ProductName
                                </div>
                                <div class="card-value">
                                    <i class="fas fa-dollar-sign"></i>
                                    @(deal.CustomerInvoiceAmount?.ToString("C0") ?? "TBD")
                                </div>
                                <div class="card-assignee">
                                    <i class="fas fa-user"></i>
                                    @(deal.AssignedTo ?? "Unassigned")
                                </div>
                            </div>
                            <div class="kanban-card-footer">
                                <div class="card-priority priority-@deal.Priority?.ToLower()">
                                    @deal.Priority
                                </div>
                                <div class="card-date">
                                    @(deal.ActualCloseDate?.ToString("MMM dd") ?? deal.ExpectedCloseDate?.ToString("MMM dd"))
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bigin.com-Style Kanban CSS -->
<style>
/* Bigin.com-Inspired Kanban Styles */
.bigin-kanban-container {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    min-height: 100vh;
    padding: 1.5rem;
}

.bigin-page-title {
    font-size: 1.8rem;
    font-weight: 700;
    color: #2d3436;
    margin-bottom: 0.5rem;
}

.bigin-subtitle {
    color: #636e72;
    font-size: 1rem;
}

.bigin-view-toggles .btn-group .btn {
    border-radius: 8px;
    margin-right: 4px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.bigin-btn-primary {
    background: linear-gradient(135deg, #6c5ce7 0%, #5a67d8 100%);
    border: none;
    border-radius: 8px;
    font-weight: 600;
    padding: 0.6rem 1.2rem;
    transition: all 0.3s ease;
}

.bigin-btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(108, 92, 231, 0.3);
}

.bigin-stat-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    display: flex;
    align-items: center;
    transition: all 0.3s ease;
}

.bigin-stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
}

.bg-gradient-primary {
    background: linear-gradient(135deg, #6c5ce7 0%, #5a67d8 100%);
    color: white;
}

.bg-gradient-success {
    background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
    color: white;
}

.bg-gradient-warning {
    background: linear-gradient(135deg, #fdcb6e 0%, #e17055 100%);
    color: white;
}

.bg-gradient-info {
    background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
    color: white;
}

.bg-gradient-secondary {
    background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
    color: white;
}

.stat-icon {
    font-size: 2.5rem;
    margin-right: 1rem;
    opacity: 0.8;
}

.stat-number {
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 0.2rem;
}

.stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
    margin-bottom: 0;
}

.kanban-board {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.kanban-columns {
    display: flex;
    gap: 1.5rem;
    overflow-x: auto;
    padding-bottom: 1rem;
}

.kanban-column {
    min-width: 320px;
    flex: 1;
    background: #f8f9fa;
    border-radius: 12px;
    overflow: hidden;
}

.kanban-column-header {
    padding: 1rem 1.5rem;
    display: flex;
    justify-content: between;
    align-items: center;
    color: white;
    font-weight: 600;
}

.column-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex: 1;
}

.column-count {
    background: rgba(255, 255, 255, 0.2);
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
}

.kanban-column-body {
    padding: 1rem;
    min-height: 600px;
    max-height: 600px;
    overflow-y: auto;
}

.kanban-card {
    background: white;
    border-radius: 8px;
    margin-bottom: 1rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    cursor: move;
}

.kanban-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
}

.kanban-card-won {
    border-left: 4px solid #00b894;
}

.kanban-card-header {
    padding: 1rem 1rem 0.5rem;
    display: flex;
    justify-content: between;
    align-items: start;
}

.card-title {
    font-size: 0.95rem;
    font-weight: 600;
    margin-bottom: 0;
    flex: 1;
    line-height: 1.3;
}

.card-actions {
    margin-left: 0.5rem;
}

.kanban-card-body {
    padding: 0.5rem 1rem;
}

.kanban-card-body > div {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.4rem;
    font-size: 0.85rem;
    color: #636e72;
}

.kanban-card-body i {
    width: 14px;
    color: #74b9ff;
}

.kanban-card-footer {
    padding: 0.5rem 1rem 1rem;
    display: flex;
    justify-content: between;
    align-items: center;
}

.card-priority {
    padding: 0.2rem 0.6rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.priority-high {
    background: #ff7675;
    color: white;
}

.priority-medium {
    background: #fdcb6e;
    color: #2d3436;
}

.priority-low {
    background: #74b9ff;
    color: white;
}

.priority-critical {
    background: #e84393;
    color: white;
}

.card-date {
    font-size: 0.8rem;
    color: #636e72;
    font-weight: 500;
}

@@media (max-width: 1200px) {
    .kanban-columns {
        flex-direction: column;
    }
    
    .kanban-column {
        min-width: 100%;
    }
    
    .kanban-column-body {
        max-height: 400px;
    }
}
</style>

<!-- Kanban JavaScript -->
<script>
// Move deal to different stage
function moveToStage(dealId, newStage) {
    if (confirm(`Are you sure you want to move this deal to ${newStage}?`)) {
        fetch(`/Deals/UpdateStage/${dealId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
            },
            body: JSON.stringify({ stage: newStage })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error updating deal stage');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating deal stage');
        });
    }
}

// Enable drag and drop functionality
document.addEventListener('DOMContentLoaded', function() {
    // Add drag and drop event listeners
    const cards = document.querySelectorAll('.kanban-card');
    const columns = document.querySelectorAll('.kanban-column-body');
    
    cards.forEach(card => {
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragend', handleDragEnd);
    });
    
    columns.forEach(column => {
        column.addEventListener('dragover', handleDragOver);
        column.addEventListener('drop', handleDrop);
    });
});

let draggedElement = null;

function handleDragStart(e) {
    draggedElement = this;
    this.style.opacity = '0.5';
}

function handleDragEnd(e) {
    this.style.opacity = '1';
    draggedElement = null;
}

function handleDragOver(e) {
    e.preventDefault();
}

function handleDrop(e) {
    e.preventDefault();
    
    if (draggedElement) {
        const dealId = draggedElement.getAttribute('data-deal-id');
        const newStage = this.parentElement.getAttribute('data-stage');
        
        // Move the element visually first
        this.appendChild(draggedElement);
        
        // Update the database
        moveToStage(dealId, newStage);
    }
}
</script>
